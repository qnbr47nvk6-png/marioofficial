<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mario H√≥a H·ªçc - Game Gi√°o D·ª•c</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }
        
        #game-container {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            overflow: hidden;
            position: relative;
        }
        
        #game-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to right, #8B4513, #A0522D);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #FFD700;
            z-index: 30;
        }
        
        #game-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        #game-stats {
            display: flex;
            gap: 15px;
        }
        
        .stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #login-screen, #start-screen, #end-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 20;
            padding: 20px;
            text-align: center;
            pointer-events: auto;
        }
        
        #start-screen, #end-screen {
            display: none;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        h2 {
            font-size: 2.2rem;
            margin-bottom: 15px;
            color: #FF6347;
        }
        
        p {
            font-size: 1.3rem;
            margin-bottom: 15px;
            text-align: center;
            max-width: 90%;
            line-height: 1.5;
        }
        
        button {
            padding: 15px 30px;
            font-size: 1.3rem;
            background: linear-gradient(to bottom, #FF6347, #FF4500);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin: 10px;
            pointer-events: auto;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        button:hover {
            background: linear-gradient(to bottom, #FF4500, #DC143C);
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        #question-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            color: white;
            z-index: 20;
            padding: 20px;
            overflow-y: auto;
            pointer-events: auto;
        }
        
        #question-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        #question-text {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
            max-height: 40%;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border-left: 4px solid #FFD700;
        }
        
        #answers-container {
            width: 100%;
            max-width: 800px;
            max-height: 45%;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .answer-option {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background: #333;
            border: 2px solid #555;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto;
            text-align: left;
        }
        
        .answer-option:hover {
            background: #444;
            border-color: #FF6347;
            transform: translateX(5px);
        }
        
        .selected {
            background: #555;
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        #submit-answer {
            margin-top: 15px;
            position: sticky;
            bottom: 15px;
            z-index: 5;
        }
        
        #result-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 25;
            padding: 20px;
            text-align: center;
            pointer-events: auto;
        }
        
        #result-text {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #FFD700;
        }
        
        #controls {
            position: absolute;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 15;
            pointer-events: none;
        }
        
        .control-btn {
            width: 90px;
            height: 90px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2rem;
            font-weight: bold;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            border: 3px solid rgba(0, 0, 0, 0.3);
            pointer-events: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        #left-btn {
            margin-right: 10px;
        }
        
        #jump-btn {
            background: rgba(255, 99, 71, 0.9);
            color: white;
        }
        
        #level-indicator {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            z-index: 15;
            border: 2px solid #FFD700;
        }
        
        #score-indicator {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            z-index: 15;
            border: 2px solid #FFD700;
        }
        
        #player-name-indicator {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            z-index: 15;
            border: 2px solid #FFD700;
        }
        
        #audio-toggle {
            position: absolute;
            top: 140px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            z-index: 15;
            cursor: pointer;
            pointer-events: auto;
            border: 2px solid #FFD700;
        }
        
        .input-field {
            width: 90%;
            max-width: 500px;
            padding: 15px;
            margin: 15px 0;
            font-size: 1.3rem;
            border: 2px solid #555;
            border-radius: 10px;
            background: #333;
            color: white;
            text-align: center;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #FF6347;
            box-shadow: 0 0 10px rgba(255, 99, 71, 0.5);
        }
        
        /* ƒê√É X√ìA #camera-indicator */
        
        #princess-container {
            margin: 20px 0;
        }
        
        #princess-container canvas {
            width: 150px;
            height: 180px;
        }
        
        /* Orientation warning */
        #orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            text-align: center;
            padding: 20px;
        }
        
        /* Fullscreen button */
        #fullscreen-toggle {
            position: absolute;
            top: 140px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            z-index: 15;
            cursor: pointer;
            pointer-events: auto;
            border: 2px solid #FFD700;
        }
        
        /* Weather indicator */
        #weather-indicator {
            position: absolute;
            top: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.1rem;
            z-index: 15;
            border: 2px solid #FFD700;
        }
        
        /* Mobile landscape optimizations */
        @media (max-width: 1024px) {
            h1 {
                font-size: 2.5rem;
            }
            
            h2 {
                font-size: 1.8rem;
            }
            
            p {
                font-size: 1.1rem;
            }
            
            button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            
            .control-btn {
                width: 70px;
                height: 70px;
                font-size: 1.8rem;
            }
            
            #game-title {
                font-size: 1.2rem;
            }
            
            .stat {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 768px) and (orientation: landscape) {
            #game-container {
                width: 100%;
                height: 100vh;
            }
            
            #game-wrapper {
                height: 100%;
            }
            
            #login-screen, #start-screen, #end-screen, #question-screen, #result-screen {
                padding: 10px;
                justify-content: flex-start;
                padding-top: 20px;
                overflow-y: auto;
            }
            
            #login-screen h1, #start-screen h1, #end-screen h1 {
                font-size: 1.8rem;
                margin-bottom: 10px;
            }
            
            #login-screen p, #start-screen p, #end-screen p {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }
            
            #login-screen button, #start-screen button, #end-screen button {
                padding: 10px 20px;
                font-size: 0.9rem;
                margin-top: 10px;
            }
            
            #question-screen {
                padding: 10px;
            }
            
            #question-text {
                font-size: 0.9rem;
                max-height: 30%;
            }
            
            #answers-container {
                max-height: 40%;
            }
            
            .answer-option {
                font-size: 0.8rem;
                padding: 10px;
            }
            
            #controls {
                bottom: 10px;
                padding: 0 10px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            #game-header {
                padding: 5px 10px;
            }
            
            #game-title {
                font-size: 1rem;
            }
            
            .stat {
                font-size: 0.7rem;
                padding: 3px 8px;
            }
        }
        
        @media (max-width: 480px) {
            #game-container {
                width: 100%;
                height: 100vh;
            }
            
            #game-wrapper {
                height: 100%;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.4rem;
            }
            
            p {
                font-size: 0.9rem;
            }
            
            button {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            #game-header {
                padding: 8px 15px;
            }
            
            #game-title {
                font-size: 1.2rem;
            }
            
            .stat {
                font-size: 0.8rem;
            }
        }
        
        /* Animation for correct/incorrect answers */
        @keyframes correctAnswer {
            0% { background-color: #333; }
            50% { background-color: #4CAF50; }
            100% { background-color: #333; }
        }
        
        @keyframes incorrectAnswer {
            0% { background-color: #333; }
            50% { background-color: #F44336; }
            100% { background-color: #333; }
        }
        
        .correct {
            animation: correctAnswer 1s;
        }
        
        .incorrect {
            animation: incorrectAnswer 1s;
        }
        
        /* Game instructions */
        #instructions {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1rem;
            z-index: 15;
            text-align: center;
            max-width: 80%;
            border: 2px solid #FFD700;
            display: none;
        }
    </style>
</head>
<body>
    <div id="orientation-warning">
        <h1>Vui l√≤ng xoay ngang ƒëi·ªán tho·∫°i</h1>
        <p>Tr√≤ ch∆°i ho·∫°t ƒë·ªông t·ªët nh·∫•t ·ªü ch·∫ø ƒë·ªô ngang</p>
    </div>
    
    <div id="game-container">
        <div id="game-header">
            <div id="game-title">Mario H√≥a H·ªçc - Game Gi√°o D·ª•c</div>
            <div id="game-stats">
                <div class="stat" id="header-level">C·∫•p ƒë·ªô: 1/5</div>
                <div class="stat" id="header-score">ƒêi·ªÉm: 0</div>
            </div>
        </div>
        
        <div id="game-wrapper">
            <canvas id="game-canvas"></canvas>
            
            <div id="ui-overlay">
                <div id="level-indicator">C·∫•p ƒë·ªô: 1/5</div>
                <div id="score-indicator">ƒêi·ªÉm: 0</div>
                <div id="player-name-indicator">Ng∆∞·ªùi ch∆°i: </div>
                <div id="audio-toggle">üîä</div>
                <div id="fullscreen-toggle">‚õ∂</div>
                <div id="weather-indicator">‚òÄÔ∏è B√¨nh minh</div>
                <!-- ƒê√É X√ìA #camera-indicator -->
                
                <div id="instructions">
                    <p>ƒêi·ªÅu khi·ªÉn: ‚Üê ‚Üí ƒë·ªÉ di chuy·ªÉn, SPACE ƒë·ªÉ nh·∫£y</p>
                    <p>Nh·∫∑t ƒë·ªìng xu v√†ng ƒë·ªÉ tƒÉng ƒëi·ªÉm!</p>
                </div>
                
                <div id="login-screen">
                    <h1>Mario H√≥a H·ªçc</h1>
                    <p>Nh·∫≠p t√™n nh√¢n v·∫≠t c·ªßa b·∫°n:</p>
                    <input type="text" id="player-name" class="input-field" placeholder="T√™n nh√¢n v·∫≠t" maxlength="15">
                    <button id="login-btn">B·∫Øt ƒê·∫ßu</button>
                    <p class="game-description">Gi√∫p Mario v∆∞·ª£t qua c√°c th·ª≠ th√°ch h√≥a h·ªçc ƒë·ªÉ gi·∫£i c·ª©u C√¥ng Ch√∫a!</p>
                </div>
                
                <div id="start-screen">
                    <h1>Mario H√≥a H·ªçc</h1>
                    <p>Ch√†o m·ª´ng <span id="welcome-name">Ng∆∞·ªùi ch∆°i</span>!</p>
                    <p>ƒêi·ªÅu khi·ªÉn: ‚Üê ‚Üí ƒë·ªÉ di chuy·ªÉn, SPACE ƒë·ªÉ nh·∫£y</p>
                    <p>Nh·∫∑t ƒë·ªìng xu v√†ng ƒë·ªÉ tƒÉng ƒëi·ªÉm s·ªë!</p>
                    <p>Nh·∫£y l√™n ƒë·∫ßu qu√°i v·∫≠t ƒë·ªÉ ti√™u di·ªát ch√∫ng!</p>
                    <button id="start-btn">B·∫Øt ƒê·∫ßu Ch∆°i</button>
                </div>
                
                <div id="question-screen">
                    <div id="question-header">
                        <h2 id="question-number">C√¢u h·ªèi 1</h2>
                    </div>
                    <p id="question-text">N·ªôi dung c√¢u h·ªèi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                    <div id="answers-container">
                        <!-- C√°c ƒë√°p √°n s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
                    </div>
                    <button id="submit-answer">Tr·∫£ L·ªùi</button>
                </div>
                
                <div id="result-screen">
                    <h2 id="result-text">K·∫øt qu·∫£</h2>
                    <p id="result-message">Th√¥ng b√°o k·∫øt qu·∫£</p>
                    <button id="result-btn">Ti·∫øp T·ª•c</button>
                </div>
                
                <div id="end-screen">
                    <h1>CH√öC M·ª™NG!</h1>
                    <p><span id="congrats-name">Ng∆∞·ªùi ch∆°i</span> ƒë√£ gi·∫£i c·ª©u ƒë∆∞·ª£c C√¥ng Ch√∫a!</p>
                    <p id="final-score">T·ªïng ƒëi·ªÉm: 0</p>
                    <div id="princess-container">
                        <!-- C√¥ng ch√∫a s·∫Ω ƒë∆∞·ª£c v·∫Ω ·ªü ƒë√¢y -->
                    </div>
                    <button id="restart-btn">Ch∆°i L·∫°i</button>
                </div>
                
                <div id="controls">
                    <div style="display: flex;">
                        <div class="control-btn" id="left-btn">‚Üê</div>
                        <div class="control-btn" id="right-btn">‚Üí</div>
                    </div>
                    <div class="control-btn" id="jump-btn">‚Üë</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gameWrapper = document.getElementById('game-wrapper');
        const loginScreen = document.getElementById('login-screen');
        const startScreen = document.getElementById('start-screen');
        const endScreen = document.getElementById('end-screen');
        const questionScreen = document.getElementById('question-screen');
        const resultScreen = document.getElementById('result-screen');
        const orientationWarning = document.getElementById('orientation-warning');
        const weatherIndicator = document.getElementById('weather-indicator');
        const fullscreenToggle = document.getElementById('fullscreen-toggle');
        const loginBtn = document.getElementById('login-btn');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const submitBtn = document.getElementById('submit-answer');
        const resultBtn = document.getElementById('result-btn');
        const playerNameInput = document.getElementById('player-name');
        const welcomeName = document.getElementById('welcome-name');
        const congratsName = document.getElementById('congrats-name');
        const playerNameIndicator = document.getElementById('player-name-indicator');
        const questionText = document.getElementById('question-text');
        const questionNumber = document.getElementById('question-number');
        const answersContainer = document.getElementById('answers-container');
        const resultText = document.getElementById('result-text');
        const resultMessage = document.getElementById('result-message');
        const levelIndicator = document.getElementById('level-indicator');
        const scoreIndicator = document.getElementById('score-indicator');
        const finalScore = document.getElementById('final-score');
        const audioToggle = document.getElementById('audio-toggle');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const jumpBtn = document.getElementById('jump-btn');
        const princessContainer = document.getElementById('princess-container');
        const headerLevel = document.getElementById('header-level');
        const headerScore = document.getElementById('header-score');
        const instructions = document.getElementById('instructions');

        // K√≠ch th∆∞·ªõc game world c·ªë ƒë·ªãnh (t·ª∑ l·ªá 16:9)
        const GAME_WIDTH = 1600;
        const GAME_HEIGHT = 900;
        
        // K√≠ch th∆∞·ªõc viewport (m√†n h√¨nh hi·ªÉn th·ªã)
        let viewport = {
            x: 0,
            y: 0,
            width: 0,
            height: 0
        };

        // Bi·∫øn scale
        let gameScale = 1;
        let offsetX = 0;
        let offsetY = 0;

        // Bi·∫øn tr√≤ ch∆°i
        let gameRunning = false;
        let currentLevel = 1;
        let player;
        let platforms = [];
        let obstacles = [];
        let enemies = [];
        let coins = [];
        let goal;
        let keys = {};
        let selectedAnswer = null;
        let currentQuestion = 0;
        let score = 0;
        let soundEnabled = true;
        let playerName = "Ng∆∞·ªùi ch∆°i";
        let touchControls = {
            left: false,
            right: false,
            jump: false
        };
        let isFullscreen = false;

        // Bi·∫øn m√¥i tr∆∞·ªùng
        let environment = {
            // Th·ªùi ti·∫øt v√† khung c·∫£nh
            weather: 'sunny',
            timeOfDay: 'morning',
            
            // C√°c y·∫øu t·ªë m√¥i tr∆∞·ªùng
            clouds: [],
            birds: [],
            trees: [],
            bushes: [],
            rainDrops: [],
            stars: [],
            
            // M√†u s·∫Øc n·ªÅn theo th·ªùi ti·∫øt
            skyColors: {
                sunny: ['#87CEEB', '#1E90FF'],
                rainy: ['#4A6572', '#344955'],
                night: ['#0F1B2D', '#1A365D']
            },
            
            // M·∫∑t tr·ªùi/m·∫∑t trƒÉng
            sun: { x: 200, y: 150, radius: 60 },
            moon: { x: 1400, y: 120, radius: 50 },
            
            // Hi·ªáu ·ª©ng
            lightningTimer: 0,
            lightningActive: false
        };

        // Kh·ªüi t·∫°o k√≠ch th∆∞·ªõc canvas v√† scale
        function initCanvasSize() {
            const containerWidth = gameWrapper.clientWidth;
            const containerHeight = gameWrapper.clientHeight;
            
            // T√≠nh t·ª∑ l·ªá scale ƒë·ªÉ fit to√†n m√†n h√¨nh
            const scaleX = containerWidth / GAME_WIDTH;
            const scaleY = containerHeight / GAME_HEIGHT;
            gameScale = Math.min(scaleX, scaleY);
            
            // T√≠nh k√≠ch th∆∞·ªõc th·ª±c t·∫ø c·ªßa game tr√™n m√†n h√¨nh
            const gameDisplayWidth = GAME_WIDTH * gameScale;
            const gameDisplayHeight = GAME_HEIGHT * gameScale;
            
            // CƒÉn gi·ªØa game
            offsetX = (containerWidth - gameDisplayWidth) / 2;
            offsetY = (containerHeight - gameDisplayHeight) / 2;
            
            // ƒê·∫∑t k√≠ch th∆∞·ªõc canvas b·∫±ng k√≠ch th∆∞·ªõc m√†n h√¨nh
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            // C·∫≠p nh·∫≠t viewport
            viewport.width = GAME_WIDTH;
            viewport.height = GAME_HEIGHT;
        }

        // Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng theo c·∫•p ƒë·ªô
        function setupEnvironment() {
            // Reset m√¥i tr∆∞·ªùng
            environment.clouds = [];
            environment.birds = [];
            environment.trees = [];
            environment.bushes = [];
            environment.rainDrops = [];
            environment.stars = [];
            environment.lightningTimer = 0;
            environment.lightningActive = false;

            // Thi·∫øt l·∫≠p theo c·∫•p ƒë·ªô
            switch(currentLevel) {
                case 1: // B√¨nh minh t∆∞∆°i s√°ng
                    environment.weather = 'sunny';
                    environment.timeOfDay = 'morning';
                    weatherIndicator.textContent = '‚òÄÔ∏è B√¨nh minh';
                    createSunnyEnvironment();
                    break;
                case 2: // Tr·ªùi m∆∞a
                    environment.weather = 'rainy';
                    environment.timeOfDay = 'afternoon';
                    weatherIndicator.textContent = 'üåßÔ∏è M∆∞a r√†o';
                    createRainyEnvironment();
                    break;
                case 3: // Ho√†ng h√¥n
                    environment.weather = 'sunny';
                    environment.timeOfDay = 'evening';
                    weatherIndicator.textContent = 'üåÖ Ho√†ng h√¥n';
                    createSunsetEnvironment();
                    break;
                case 4: // ƒê√™m c√≥ sao
                    environment.weather = 'night';
                    environment.timeOfDay = 'night';
                    weatherIndicator.textContent = 'üåÉ ƒê√™m sao';
                    createNightEnvironment();
                    break;
                case 5: // B√£o t·ªë
                    environment.weather = 'rainy';
                    environment.timeOfDay = 'night';
                    weatherIndicator.textContent = '‚õàÔ∏è B√£o t·ªë';
                    createStormEnvironment();
                    break;
            }
        }

        // T·∫°o m√¥i tr∆∞·ªùng n·∫Øng
        function createSunnyEnvironment() {
            // T·∫°o m√¢y
            for (let i = 0; i < 8; i++) {
                environment.clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: 80 + Math.random() * 100,
                    width: 120 + Math.random() * 80,
                    height: 60 + Math.random() * 40,
                    speed: 0.2 + Math.random() * 0.3
                });
            }
            
            // T·∫°o chim
            for (let i = 0; i < 5; i++) {
                environment.birds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: 50 + Math.random() * 100,
                    speed: 2 + Math.random() * 1,
                    wingPhase: Math.random() * Math.PI * 2
                });
            }
            
            // T·∫°o c√¢y
            for (let i = 0; i < 6; i++) {
                environment.trees.push({
                    x: 100 + i * 250,
                    y: GAME_HEIGHT - 30,
                    height: 120 + Math.random() * 60,
                    type: Math.floor(Math.random() * 3)
                });
            }
            
            // T·∫°o b·ª•i c√¢y
            for (let i = 0; i < 10; i++) {
                environment.bushes.push({
                    x: Math.random() * GAME_WIDTH,
                    y: GAME_HEIGHT - 30,
                    size: 30 + Math.random() * 40
                });
            }
        }

        // T·∫°o m√¥i tr∆∞·ªùng m∆∞a
        function createRainyEnvironment() {
            // T·∫°o m√¢y ƒëen
            for (let i = 0; i < 10; i++) {
                environment.clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: 60 + Math.random() * 80,
                    width: 150 + Math.random() * 100,
                    height: 80 + Math.random() * 60,
                    speed: 0.4 + Math.random() * 0.4,
                    dark: true
                });
            }
            
            // T·∫°o h·∫°t m∆∞a
            for (let i = 0; i < 100; i++) {
                environment.rainDrops.push({
                    x: Math.random() * GAME_WIDTH,
                    y: Math.random() * GAME_HEIGHT,
                    length: 10 + Math.random() * 10,
                    speed: 8 + Math.random() * 4
                });
            }
            
            // T·∫°o c√¢y √≠t h∆°n
            for (let i = 0; i < 4; i++) {
                environment.trees.push({
                    x: 200 + i * 350,
                    y: GAME_HEIGHT - 30,
                    height: 100 + Math.random() * 80,
                    type: Math.floor(Math.random() * 3)
                });
            }
        }

        // T·∫°o m√¥i tr∆∞·ªùng ho√†ng h√¥n
        function createSunsetEnvironment() {
            // T·∫°o m√¢y
            for (let i = 0; i < 6; i++) {
                environment.clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: 100 + Math.random() * 120,
                    width: 140 + Math.random() * 100,
                    height: 70 + Math.random() * 50,
                    speed: 0.3 + Math.random() * 0.2,
                    sunset: true
                });
            }
            
            // T·∫°o chim bay v·ªÅ t·ªï
            for (let i = 0; i < 3; i++) {
                environment.birds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: 80 + Math.random() * 150,
                    speed: 3 + Math.random() * 1,
                    wingPhase: Math.random() * Math.PI * 2,
                    goingRight: Math.random() > 0.5
                });
            }
            
            // T·∫°o c√¢y silhouette
            for (let i = 0; i < 5; i++) {
                environment.trees.push({
                    x: 150 + i * 280,
                    y: GAME_HEIGHT - 30,
                    height: 140 + Math.random() * 80,
                    type: Math.floor(Math.random() * 3),
                    silhouette: true
                });
            }
        }

        // T·∫°o m√¥i tr∆∞·ªùng ƒë√™m
        function createNightEnvironment() {
            // T·∫°o sao
            for (let i = 0; i < 50; i++) {
                environment.stars.push({
                    x: Math.random() * GAME_WIDTH,
                    y: Math.random() * 400,
                    size: 1 + Math.random() * 2,
                    brightness: 0.3 + Math.random() * 0.7
                });
            }
            
            // T·∫°o m√¢y ƒë√™m
            for (let i = 0; i < 4; i++) {
                environment.clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: 120 + Math.random() * 100,
                    width: 100 + Math.random() * 80,
                    height: 50 + Math.random() * 40,
                    speed: 0.2 + Math.random() * 0.2,
                    night: true
                });
            }
            
            // T·∫°o c√¢y ƒë√™m
            for (let i = 0; i < 5; i++) {
                environment.trees.push({
                    x: 180 + i * 290,
                    y: GAME_HEIGHT - 30,
                    height: 110 + Math.random() * 70,
                    type: Math.floor(Math.random() * 3),
                    night: true
                });
            }
        }

        // T·∫°o m√¥i tr∆∞·ªùng b√£o
        function createStormEnvironment() {
            // T·∫°o m√¢y b√£o
            for (let i = 0; i < 12; i++) {
                environment.clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: 40 + Math.random() * 60,
                    width: 180 + Math.random() * 120,
                    height: 100 + Math.random() * 80,
                    speed: 0.6 + Math.random() * 0.4,
                    storm: true
                });
            }
            
            // T·∫°o m∆∞a l·ªõn
            for (let i = 0; i < 150; i++) {
                environment.rainDrops.push({
                    x: Math.random() * GAME_WIDTH,
                    y: Math.random() * GAME_HEIGHT,
                    length: 15 + Math.random() * 15,
                    speed: 12 + Math.random() * 6
                });
            }
            
            // Thi·∫øt l·∫≠p timer cho s·∫•m s√©t
            environment.lightningTimer = 180;
        }

        // C·∫≠p nh·∫≠t m√¥i tr∆∞·ªùng
        function updateEnvironment() {
            // C·∫≠p nh·∫≠t m√¢y
            environment.clouds.forEach(cloud => {
                cloud.x += cloud.speed;
                if (cloud.x > GAME_WIDTH + cloud.width) {
                    cloud.x = -cloud.width;
                }
            });
            
            // C·∫≠p nh·∫≠t chim
            environment.birds.forEach(bird => {
                if (bird.goingRight !== undefined) {
                    bird.x += bird.goingRight ? bird.speed : -bird.speed;
                    if (bird.x > GAME_WIDTH + 50) bird.x = -50;
                    if (bird.x < -50) bird.x = GAME_WIDTH + 50;
                } else {
                    bird.x += bird.speed;
                    if (bird.x > GAME_WIDTH + 50) bird.x = -50;
                }
                bird.wingPhase += 0.3;
            });
            
            // C·∫≠p nh·∫≠t m∆∞a
            environment.rainDrops.forEach(drop => {
                drop.y += drop.speed;
                if (drop.y > GAME_HEIGHT) {
                    drop.y = -20;
                    drop.x = Math.random() * GAME_WIDTH;
                }
            });
            
            // C·∫≠p nh·∫≠t s·∫•m s√©t
            if (environment.lightningTimer > 0) {
                environment.lightningTimer--;
                if (environment.lightningTimer === 0) {
                    environment.lightningActive = true;
                    setTimeout(() => {
                        environment.lightningActive = false;
                        environment.lightningTimer = 120 + Math.random() * 180;
                    }, 100);
                }
            }
        }

        // V·∫Ω m√¥i tr∆∞·ªùng
        function drawEnvironment() {
            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(gameScale, gameScale);
            ctx.translate(-viewport.x, -viewport.y);
            
            // V·∫Ω n·ªÅn tr·ªùi v·ªõi gradient
            const skyGradient = ctx.createLinearGradient(0, 0, 0, GAME_HEIGHT);
            const colors = environment.skyColors[environment.weather];
            skyGradient.addColorStop(0, colors[0]);
            skyGradient.addColorStop(1, colors[1]);
            
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            // V·∫Ω m·∫∑t tr·ªùi/m·∫∑t trƒÉng
            if (environment.timeOfDay === 'morning' || environment.timeOfDay === 'evening') {
                // M·∫∑t tr·ªùi
                ctx.fillStyle = environment.timeOfDay === 'morning' ? '#FFD700' : '#FF4500';
                ctx.beginPath();
                ctx.arc(environment.sun.x, environment.sun.y, environment.sun.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // Hi·ªáu ·ª©ng √°nh s√°ng m·∫∑t tr·ªùi
                if (environment.timeOfDay === 'morning') {
                    const sunGradient = ctx.createRadialGradient(
                        environment.sun.x, environment.sun.y, environment.sun.radius,
                        environment.sun.x, environment.sun.y, environment.sun.radius * 3
                    );
                    sunGradient.addColorStop(0, 'rgba(255, 215, 0, 0.3)');
                    sunGradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
                    ctx.fillStyle = sunGradient;
                    ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                }
            }
            
            if (environment.timeOfDay === 'night') {
                // M·∫∑t trƒÉng
                ctx.fillStyle = '#F0F0F0';
                ctx.beginPath();
                ctx.arc(environment.moon.x, environment.moon.y, environment.moon.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // V·∫Ω sao
                environment.stars.forEach(star => {
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness})`;
                    ctx.fillRect(star.x, star.y, star.size, star.size);
                });
            }
            
            // V·∫Ω m√¢y
            environment.clouds.forEach(cloud => {
                if (cloud.dark) {
                    ctx.fillStyle = '#2C3E50';
                } else if (cloud.sunset) {
                    ctx.fillStyle = '#E67E22';
                } else if (cloud.night) {
                    ctx.fillStyle = '#34495E';
                } else if (cloud.storm) {
                    ctx.fillStyle = '#2C3E50';
                } else {
                    ctx.fillStyle = '#FFFFFF';
                }
                
                ctx.beginPath();
                ctx.ellipse(cloud.x, cloud.y, cloud.width/2, cloud.height/2, 0, 0, Math.PI * 2);
                ctx.ellipse(cloud.x - cloud.width/4, cloud.y, cloud.width/3, cloud.height/1.5, 0, 0, Math.PI * 2);
                ctx.ellipse(cloud.x + cloud.width/4, cloud.y, cloud.width/3, cloud.height/1.5, 0, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // V·∫Ω chim
            environment.birds.forEach(bird => {
                ctx.fillStyle = '#333333';
                ctx.save();
                ctx.translate(bird.x, bird.y);
                
                // Th√¢n chim
                ctx.beginPath();
                ctx.ellipse(0, 0, 8, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // C√°nh chim
                ctx.beginPath();
                ctx.ellipse(-3, Math.sin(bird.wingPhase) * 3, 6, 4, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            });
            
            // V·∫Ω c√¢y
            environment.trees.forEach(tree => {
                if (tree.silhouette) {
                    ctx.fillStyle = '#2C3E50';
                } else if (tree.night) {
                    ctx.fillStyle = '#34495E';
                } else {
                    ctx.fillStyle = '#228B22';
                }
                
                // Th√¢n c√¢y
                ctx.fillRect(tree.x - 8, tree.y - tree.height, 16, tree.height - 20);
                
                // T√°n c√¢y
                ctx.beginPath();
                if (tree.type === 0) {
                    // C√¢y tr√≤n
                    ctx.arc(tree.x, tree.y - tree.height + 10, 40, 0, Math.PI * 2);
                } else if (tree.type === 1) {
                    // C√¢y tam gi√°c
                    ctx.moveTo(tree.x - 45, tree.y - tree.height + 50);
                    ctx.lineTo(tree.x, tree.y - tree.height - 10);
                    ctx.lineTo(tree.x + 45, tree.y - tree.height + 50);
                } else {
                    // C√¢y r·∫≠m r·∫°p
                    ctx.ellipse(tree.x - 20, tree.y - tree.height + 30, 35, 25, 0, 0, Math.PI * 2);
                    ctx.ellipse(tree.x + 20, tree.y - tree.height + 30, 35, 25, 0, 0, Math.PI * 2);
                    ctx.ellipse(tree.x, tree.y - tree.height, 40, 30, 0, 0, Math.PI * 2);
                }
                ctx.fill();
            });
            
            // V·∫Ω b·ª•i c√¢y
            environment.bushes.forEach(bush => {
                ctx.fillStyle = '#27AE60';
                ctx.beginPath();
                ctx.arc(bush.x, bush.y - 10, bush.size/2, 0, Math.PI * 2);
                ctx.arc(bush.x - bush.size/3, bush.y - 15, bush.size/3, 0, Math.PI * 2);
                ctx.arc(bush.x + bush.size/3, bush.y - 15, bush.size/3, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // V·∫Ω m∆∞a
            environment.rainDrops.forEach(drop => {
                ctx.strokeStyle = environment.weather === 'rainy' ? '#3498DB' : '#BDC3C7';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(drop.x, drop.y);
                ctx.lineTo(drop.x - 3, drop.y + drop.length);
                ctx.stroke();
            });
            
            // Hi·ªáu ·ª©ng s·∫•m s√©t
            if (environment.lightningActive) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            }
            
            ctx.restore();
        }

        // C·∫≠p nh·∫≠t camera theo v·ªã tr√≠ ng∆∞·ªùi ch∆°i - ƒê√É X√ìA HI·ªÇN TH·ªä CAMERA INDICATOR
        function updateCamera() {
            if (!player) return;
            
            // Tr√™n m√†n h√¨nh l·ªõn, camera c·ªë ƒë·ªãnh ƒë·ªÉ hi·ªÉn th·ªã to√†n b·ªô game world
            if (window.innerWidth >= GAME_WIDTH && window.innerHeight >= GAME_HEIGHT) {
                viewport.x = 0;
                viewport.y = 0;
                return;
            }
            
            // Tr√™n m√†n h√¨nh nh·ªè, camera theo d√µi ng∆∞·ªùi ch∆°i
            viewport.x = player.x - viewport.width / 2;
            viewport.y = player.y - viewport.height / 2;
            
            // Gi·ªõi h·∫°n camera trong game world
            viewport.x = Math.max(0, Math.min(viewport.x, GAME_WIDTH - viewport.width));
            viewport.y = Math.max(0, Math.min(viewport.y, GAME_HEIGHT - viewport.height));
            
            // ƒê√É X√ìA HI·ªÇN TH·ªä CAMERA INDICATOR
        }

        // Ki·ªÉm tra h∆∞·ªõng m√†n h√¨nh
        function checkOrientation() {
            const isPortrait = window.innerHeight > window.innerWidth;
            // Ch·ªâ hi·ªÉn th·ªã c·∫£nh b√°o tr√™n mobile
            const isMobile = window.innerWidth <= 768;
            
            if (isPortrait && isMobile) {
                orientationWarning.style.display = 'flex';
                // ·∫®n t·∫•t c·∫£ c√°c m√†n h√¨nh kh√°c
                loginScreen.style.display = 'none';
                startScreen.style.display = 'none';
                endScreen.style.display = 'none';
                questionScreen.style.display = 'none';
                resultScreen.style.display = 'none';
            } else {
                orientationWarning.style.display = 'none';
                // Hi·ªÉn th·ªã m√†n h√¨nh ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a c√≥
                if (!gameRunning && loginScreen.style.display !== 'flex' && 
                    startScreen.style.display !== 'flex' && 
                    endScreen.style.display !== 'flex') {
                    loginScreen.style.display = 'flex';
                }
            }
        }

        // Fullscreen toggle
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                if (gameWrapper.requestFullscreen) {
                    gameWrapper.requestFullscreen();
                } else if (gameWrapper.webkitRequestFullscreen) {
                    gameWrapper.webkitRequestFullscreen();
                } else if (gameWrapper.msRequestFullscreen) {
                    gameWrapper.msRequestFullscreen();
                }
                isFullscreen = true;
                fullscreenToggle.textContent = '‚õ∂';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                isFullscreen = false;
                fullscreenToggle.textContent = '‚õ∂';
            }
        }

        // T·∫°o √¢m thanh b·∫±ng Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(frequency, duration, type = 'sine') {
            if (!soundEnabled) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        // √Çm thanh cho c√°c s·ª± ki·ªán
        function playJumpSound() {
            playSound(523.25, 0.3, 'square');
        }
        
        function playCoinSound() {
            playSound(659.25, 0.2, 'triangle');
        }
        
        function playCorrectSound() {
            playSound(783.99, 0.5, 'sine');
            playSound(1046.50, 0.5, 'sine');
        }
        
        function playWrongSound() {
            playSound(220, 0.5, 'sawtooth');
        }
        
        function playWinSound() {
            playSound(523.25, 0.2, 'sine');
            playSound(659.25, 0.2, 'sine');
            playSound(783.99, 0.2, 'sine');
            playSound(1046.50, 0.5, 'sine');
        }
        
        function playEnemyDefeatSound() {
            playSound(392, 0.3, 'sawtooth');
        }
        
        function playEnemyHitSound() {
            playSound(196, 0.5, 'square');
        }
        
        function playThunderSound() {
            playSound(80, 0.8, 'sawtooth');
            setTimeout(() => playSound(60, 0.6, 'sawtooth'), 300);
        }
        
        function playBackgroundMusic() {
            if (!soundEnabled) return;
            
            // T·∫°o √¢m nh·∫°c n·ªÅn ƒë∆°n gi·∫£n
            setInterval(() => {
                playSound(523.25, 0.1, 'sine');
                setTimeout(() => playSound(659.25, 0.1, 'sine'), 100);
                setTimeout(() => playSound(783.99, 0.1, 'sine'), 200);
            }, 2000);
        }

        // C√¢u h·ªèi h√≥a h·ªçc
        const questions = [
            {
                text: "T·ª´ m·ªôt mi·∫øng ƒë√° v√¥i v√† m·ªôt l·ªç ƒë·ª±ng dd HCl 1M, th√≠ nghi·ªám ƒë∆∞·ª£c ti·∫øn h√†nh trong ƒëi·ªÅu ki·ªán n√†o sau ƒë√¢y s·∫Ω thu ƒë∆∞·ª£c l∆∞·ª£ng CO‚ÇÇ l·ªõn nh·∫•t trong m·ªôt kho·∫£ng th·ªùi gian x√°c ƒë·ªãnh?",
                options: [
                    "A. T√°n nh·ªè mi·∫øng ƒë√° v√¥i, cho v√†o dung d·ªãch HCl 1M, kh√¥ng ƒëun n√≥ng.",
                    "B. T√°n nh·ªè mi·∫øng ƒë√° v√¥i, cho v√†o dung d·ªãch HCl 1M, ƒëun n√≥ng.",
                    "C. Cho mi·∫øng ƒë√° v√¥i v√†o dung d·ªãch HCl 1M, kh√¥ng ƒëun n√≥ng.",
                    "D. Cho mi·∫øng ƒë√° v√¥i v√†o dung d·ªãch HCl 1M, ƒëun n√≥ng."
                ],
                correct: 1
            },
            {
                text: "Cho ph·∫£n ·ª©ng h√≥a h·ªçc sau: C (s) + O2 (g) ‚Üí CO2 (g). Y·∫øu t·ªë n√†o sau ƒë√¢y kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn t·ªëc ƒë·ªô ph·∫£n ·ª©ng tr√™n?",
                options: [
                    "A. Nhi·ªát ƒë·ªô",
                    "B. √Åp su·∫•t O2",
                    "C. H√†m l∆∞·ª£ng carbon",
                    "D. Di·ªán t√≠ch b·ªÅ m·∫∑t carbon"
                ],
                correct: 2
            },
            {
                text: "D∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë hi·ªán t∆∞·ª£ng x·∫£y ra trong ƒë·ªùi s·ªëng, h√£y s·∫Øp x·∫øp theo th·ª© t·ª± t·ªëc ƒë·ªô ph·∫£n ·ª©ng gi·∫£m d·∫ßn: (1) Ph·∫£n ·ª©ng ch√°y c·ªßa xƒÉng, d·∫ßu. (2) C√°c thanh th√©p ·ªü c√°c c√¥ng tr∆∞·ªùng x√¢y d·ª±ng b·ªã oxi h√≥a b·ªüi c√°c t√°c nh√¢n trong kh√¥ng kh√≠. (3) Ph·∫£n ·ª©ng l√™n men r∆∞·ª£u t·ª´ tr√°i c√¢y. (4) N∆∞·ªõng b√°nh m√¨.",
                options: [
                    "A. 1 > 4 > 3 > 2",
                    "B. 1 > 4 > 2 > 3",
                    "C. 4 > 1 > 2 > 3",
                    "D. 1 > 3 > 4 > 2"
                ],
                correct: 0
            },
            {
                text: "Trong ph√≤ng th√≠ nghi·ªám, c√≥ th·ªÉ ƒëi·ªÅu ch·∫ø kh√≠ oxygen t·ª´ mu·ªëi potassium chlorate (KClO‚ÇÉ). Ng∆∞·ªùi ta s·ª≠ d·ª•ng c√°ch n√†o sau ƒë√¢y nh·∫±m m·ª•c ƒë√≠ch tƒÉng t·ªëc ƒë·ªô ph·∫£n ·ª©ng?",
                options: [
                    "A. Nung potassium chorate ·ªü nhi·ªát ƒë·ªô cao.",
                    "B. Nung h·ªón h·ª£p potassium chorate v√† manganese dioxide ·ªü nhi·ªát ƒë·ªô cao",
                    "C. D√πng ph∆∞∆°ng ph√°p d·ªùi n∆∞·ªõc ƒë·ªÉ thu kh√≠ oxygen.",
                    "D. D√πng ph∆∞∆°ng ph√°p d·ªùi kh√¥ng kh√≠ ƒë·ªÉ thu ƒë∆∞·ª£c kh√≠ oxygen."
                ],
                correct: 1
            },
            {
                text: "Cho ba m·∫´u ƒë√° v√¥i (100% CaCO‚ÇÉ) c√≥ c√πng kh·ªëi l∆∞·ª£ng: m·∫´u 1 d·∫°ng kh·ªëi, m·∫´u 2 d·∫°ng vi√™n nh·ªè, m·∫´u 3 d·∫°ng b·ªôt m·ªãn v√†o ba c·ªëc d·ª±ng c√πng th·ªÉ t√≠ch dung d·ªãch HCI (d∆∞, c√πng n·ªìng ƒë·ªô, ·ªü ƒëi·ªÅu ki·ªán th∆∞·ªùng). Th·ªùi gian ƒë·ªÉ ƒë√° v√¥i tan h·∫øt trong ba c·ªëc t∆∞∆°ng ·ª©ng l√† t‚ÇÅ, t‚ÇÇ, t‚ÇÉ gi√¢y. So s√°nh n√†o sau ƒë√¢y ƒë√∫ng?",
                options: [
                    "A. t‚ÇÉ < t‚ÇÇ < t‚ÇÅ",
                    "B. t‚ÇÅ < t‚ÇÇ < t‚ÇÉ",
                    "C. t‚ÇÅ = t‚ÇÇ = t‚ÇÉ",
                    "D. t‚ÇÇ < t‚ÇÅ < t‚ÇÉ"
                ],
                correct: 0
            }
        ];

        // L·ªõp nh√¢n v·∫≠t Mario
        class Player {
            constructor() {
                this.width = 40;
                this.height = 60;
                this.x = 100;
                this.y = GAME_HEIGHT - this.height - 100;
                this.velocityX = 0;
                this.velocityY = 0;
                this.jumping = false;
                this.speed = 5;
                this.jumpPower = 15;
                this.gravity = 0.8;
                this.friction = 0.8;
                this.direction = 1; // 1: right, -1: left
                this.invincible = false;
                this.invincibleTimer = 0;
            }
            
            update() {
                // Gi·∫£m th·ªùi gian b·∫•t t·ª≠ n·∫øu c√≥
                if (this.invincible) {
                    this.invincibleTimer--;
                    if (this.invincibleTimer <= 0) {
                        this.invincible = false;
                    }
                }
                
                // √Åp d·ª•ng tr·ªçng l·ª±c
                this.velocityY += this.gravity;
                
                // √Åp d·ª•ng ma s√°t
                this.velocityX *= this.friction;
                
                // X·ª≠ l√Ω ƒëi·ªÅu khi·ªÉn
                if (keys['ArrowLeft'] || touchControls.left) {
                    this.velocityX = -this.speed;
                    this.direction = -1;
                }
                if (keys['ArrowRight'] || touchControls.right) {
                    this.velocityX = this.speed;
                    this.direction = 1;
                }
                if ((keys[' '] || keys['ArrowUp'] || touchControls.jump) && !this.jumping) {
                    this.velocityY = -this.jumpPower;
                    this.jumping = true;
                    playJumpSound();
                }
                
                // C·∫≠p nh·∫≠t v·ªã tr√≠
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                // Gi·ªõi h·∫°n trong game world
                if (this.x < 0) this.x = 0;
                if (this.x + this.width > GAME_WIDTH) this.x = GAME_WIDTH - this.width;
                if (this.y > GAME_HEIGHT - this.height) {
                    this.y = GAME_HEIGHT - this.height;
                    this.velocityY = 0;
                    this.jumping = false;
                }
                
                // Ki·ªÉm tra va ch·∫°m v·ªõi n·ªÅn
                for (let platform of platforms) {
                    if (this.x < platform.x + platform.width &&
                        this.x + this.width > platform.x &&
                        this.y + this.height > platform.y &&
                        this.y < platform.y + platform.height &&
                        this.velocityY > 0) {
                        this.y = platform.y - this.height;
                        this.velocityY = 0;
                        this.jumping = false;
                    }
                }
                
                // Ki·ªÉm tra va ch·∫°m v·ªõi ch∆∞·ªõng ng·∫°i v·∫≠t
                for (let obstacle of obstacles) {
                    if (this.x < obstacle.x + obstacle.width &&
                        this.x + this.width > obstacle.x &&
                        this.y + this.height > obstacle.y &&
                        this.y < obstacle.y + obstacle.height) {
                        // Va ch·∫°m v·ªõi ch∆∞·ªõng ng·∫°i v·∫≠t - quay l·∫°i ƒëi·ªÉm b·∫Øt ƒë·∫ßu
                        this.reset();
                        playWrongSound();
                    }
                }
                
                // Ki·ªÉm tra va ch·∫°m v·ªõi qu√°i v·∫≠t
                for (let i = enemies.length - 1; i >= 0; i--) {
                    let enemy = enemies[i];
                    
                    // Ki·ªÉm tra n·∫øu nh√¢n v·∫≠t nh·∫£y l√™n ƒë·∫ßu qu√°i v·∫≠t
                    if (this.velocityY > 0 && 
                        this.x < enemy.x + enemy.width &&
                        this.x + this.width > enemy.x &&
                        this.y + this.height > enemy.y &&
                        this.y < enemy.y + enemy.height / 2) {
                        // Ti√™u di·ªát qu√°i v·∫≠t
                        enemies.splice(i, 1);
                        score += 30;
                        updateScore();
                        playEnemyDefeatSound();
                        this.velocityY = -this.jumpPower / 2; // Nh·∫£y nh·∫π l√™n
                    }
                    // Ki·ªÉm tra n·∫øu qu√°i v·∫≠t ch·∫°m v√†o ng∆∞·ªùi ch∆°i
                    else if (!this.invincible &&
                             this.x < enemy.x + enemy.width &&
                             this.x + this.width > enemy.x &&
                             this.y + this.height > enemy.y &&
                             this.y < enemy.y + enemy.height) {
                        // Qu√°i v·∫≠t ch·∫°m v√†o ng∆∞·ªùi ch∆°i - quay l·∫°i ƒëi·ªÉm b·∫Øt ƒë·∫ßu
                        this.reset();
                        playEnemyHitSound();
                        this.invincible = true;
                        this.invincibleTimer = 60; // 1 gi√¢y b·∫•t t·ª≠
                    }
                }
                
                // Ki·ªÉm tra nh·∫∑t ƒë·ªìng ti·ªÅn
                for (let i = coins.length - 1; i >= 0; i--) {
                    let coin = coins[i];
                    if (this.x < coin.x + coin.width &&
                        this.x + this.width > coin.x &&
                        this.y + this.height > coin.y &&
                        this.y < coin.y + coin.height) {
                        // Nh·∫∑t ƒë∆∞·ª£c ƒë·ªìng ti·ªÅn
                        coins.splice(i, 1);
                        score += 10;
                        updateScore();
                        playCoinSound();
                    }
                }
                
                // Ki·ªÉm tra ƒë·∫øn ƒë√≠ch
                if (this.x < goal.x + goal.width &&
                    this.x + this.width > goal.x &&
                    this.y + this.height > goal.y &&
                    this.y < goal.y + goal.height) {
                    // ƒê·∫øn ƒë√≠ch - hi·ªÉn th·ªã c√¢u h·ªèi
                    showQuestion();
                }
                
                // C·∫≠p nh·∫≠t camera
                updateCamera();
            }
            
            draw() {
                ctx.save();
                
                // √Åp d·ª•ng scale v√† offset
                ctx.translate(offsetX, offsetY);
                ctx.scale(gameScale, gameScale);
                
                // √Åp d·ª•ng camera transform
                ctx.translate(-viewport.x, -viewport.y);
                
                // Hi·ªáu ·ª©ng nh·∫•p nh√°y khi b·∫•t t·ª≠
                if (this.invincible && Math.floor(this.invincibleTimer / 5) % 2 === 0) {
                    ctx.globalAlpha = 0.5;
                }
                
                // ƒêi·ªÅu ch·ªânh h∆∞·ªõng v·∫Ω d·ª±a tr√™n h∆∞·ªõng di chuy·ªÉn
                if (this.direction === -1) {
                    ctx.translate(this.x + this.width, this.y);
                    ctx.scale(-1, 1);
                } else {
                    ctx.translate(this.x, this.y);
                }
                
                // M≈© ƒë·ªè
                ctx.fillStyle = '#E52521';
                ctx.fillRect(5, 5, 30, 15);
                ctx.fillRect(0, 15, 40, 10);
                
                // T√≥c v√† tai
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(10, 20, 20, 5); // T√≥c
                ctx.fillRect(35, 15, 5, 10); // Tai ph·∫£i
                ctx.fillRect(0, 15, 5, 10);  // Tai tr√°i
                
                // M·∫∑t
                ctx.fillStyle = '#FFC0CB';
                ctx.fillRect(10, 25, 20, 15);
                
                // M·∫Øt
                ctx.fillStyle = '#000000';
                ctx.fillRect(15, 30, 3, 3);
                ctx.fillRect(22, 30, 3, 3);
                
                // ·ª¶ng
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(5, 40, 10, 20);
                ctx.fillRect(25, 40, 10, 20);
                
                // Qu·∫ßn √°o
                ctx.fillStyle = '#3751E0';
                ctx.fillRect(10, 40, 20, 10);
                
                // Tay
                ctx.fillStyle = '#FFC0CB';
                ctx.fillRect(5, 35, 5, 10);
                ctx.fillRect(30, 35, 5, 10);
                
                ctx.restore();
            }
            
            reset() {
                this.x = 100;
                this.y = GAME_HEIGHT - this.height - 100;
                this.velocityX = 0;
                this.velocityY = 0;
                this.jumping = false;
                // Reset camera v·ªÅ v·ªã tr√≠ ban ƒë·∫ßu
                viewport.x = 0;
                viewport.y = 0;
            }
        }

        // L·ªõp qu√°i v·∫≠t c∆° b·∫£n
        class Enemy {
            constructor(x, y, width, height, speed = 1, platform, type = 'basic') {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.speed = speed;
                this.direction = 1; // 1: right, -1: left
                this.animationFrame = 0;
                this.platform = platform;
                this.minX = platform.x;
                this.maxX = platform.x + platform.width - this.width;
                this.type = type;
            }
            
            update() {
                // Di chuy·ªÉn qua l·∫°i tr√™n n·ªÅn
                this.x += this.speed * this.direction;
                
                // ƒê·ªïi h∆∞·ªõng khi ch·∫°m bi√™n c·ªßa n·ªÅn
                if (this.x <= this.minX || this.x >= this.maxX) {
                    this.direction *= -1;
                }
                
                // C·∫≠p nh·∫≠t animation
                this.animationFrame = (this.animationFrame + 0.1) % 10;
            }
            
            draw() {
                ctx.save();
                
                // √Åp d·ª•ng scale v√† offset
                ctx.translate(offsetX, offsetY);
                ctx.scale(gameScale, gameScale);
                
                // √Åp d·ª•ng camera transform
                ctx.translate(-viewport.x, -viewport.y);
                ctx.translate(this.x, this.y);
                
                // V·∫Ω c√°c lo·∫°i qu√°i v·∫≠t kh√°c nhau
                switch(this.type) {
                    case 'spiky':
                        this.drawSpikyEnemy();
                        break;
                    case 'fire':
                        this.drawFireEnemy();
                        break;
                    case 'ghost':
                        this.drawGhostEnemy();
                        break;
                    case 'turtle':
                        this.drawTurtleEnemy();
                        break;
                    default:
                        this.drawBasicEnemy();
                }
                
                ctx.restore();
            }
            
            drawBasicEnemy() {
                // Th√¢n qu√°i v·∫≠t (m√†u xanh l√°)
                ctx.fillStyle = '#32CD32';
                ctx.fillRect(0, 0, this.width, this.height);
                
                // M·∫Øt
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(5, 5, 8, 8);
                ctx.fillRect(this.width - 13, 5, 8, 8);
                
                ctx.fillStyle = '#000000';
                ctx.fillRect(7, 7, 4, 4);
                ctx.fillRect(this.width - 11, 7, 4, 4);
                
                // Mi·ªáng
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(10, this.height - 10, this.width - 20, 5);
                
                // Ch√¢n (hi·ªáu ·ª©ng di chuy·ªÉn)
                ctx.fillStyle = '#228B22';
                if (Math.floor(this.animationFrame) % 2 === 0) {
                    ctx.fillRect(5, this.height, 5, 10);
                    ctx.fillRect(this.width - 10, this.height, 5, 10);
                } else {
                    ctx.fillRect(10, this.height, 5, 10);
                    ctx.fillRect(this.width - 15, this.height, 5, 10);
                }
            }
            
            drawSpikyEnemy() {
                // Th√¢n qu√°i v·∫≠t (m√†u t√≠m)
                ctx.fillStyle = '#8A2BE2';
                ctx.fillRect(0, 0, this.width, this.height);
                
                // Gai tr√™n l∆∞ng
                ctx.fillStyle = '#4B0082';
                for (let i = 5; i < this.width - 5; i += 10) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i + 5, -8);
                    ctx.lineTo(i + 10, 0);
                    ctx.closePath();
                    ctx.fill();
                }
                
                // M·∫Øt
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(8, 8, 6, 6);
                ctx.fillRect(this.width - 14, 8, 6, 6);
                
                ctx.fillStyle = '#000000';
                ctx.fillRect(9, 9, 4, 4);
                ctx.fillRect(this.width - 13, 9, 4, 4);
                
                // Ch√¢n
                ctx.fillStyle = '#6A0DAD';
                ctx.fillRect(8, this.height, 6, 8);
                ctx.fillRect(this.width - 14, this.height, 6, 8);
            }
            
            drawFireEnemy() {
                // Th√¢n qu√°i v·∫≠t (m√†u cam)
                ctx.fillStyle = '#FF4500';
                ctx.fillRect(0, 0, this.width, this.height);
                
                // L·ª≠a tr√™n ƒë·∫ßu
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.moveTo(this.width/2, -5);
                ctx.lineTo(this.width/2 - 8, 5);
                ctx.lineTo(this.width/2 + 8, 5);
                ctx.closePath();
                ctx.fill();
                
                // M·∫Øt l·ª≠a
                ctx.fillStyle = '#FFFF00';
                ctx.fillRect(8, 8, 6, 6);
                ctx.fillRect(this.width - 14, 8, 6, 6);
                
                // Mi·ªáng
                ctx.fillStyle = '#8B0000';
                ctx.fillRect(10, this.height - 8, this.width - 20, 4);
                
                // Ch√¢n
                ctx.fillStyle = '#B22222';
                ctx.fillRect(8, this.height, 6, 8);
                ctx.fillRect(this.width - 14, this.height, 6, 8);
            }
            
            drawGhostEnemy() {
                // Th√¢n ma (m√†u xanh nh·∫°t, trong su·ªët)
                ctx.fillStyle = 'rgba(173, 216, 230, 0.7)';
                ctx.beginPath();
                ctx.moveTo(0, this.height/2);
                ctx.quadraticCurveTo(this.width/2, 0, this.width, this.height/2);
                ctx.quadraticCurveTo(this.width, this.height, this.width/2, this.height - 10);
                ctx.quadraticCurveTo(0, this.height, 0, this.height/2);
                ctx.fill();
                
                // M·∫Øt ma
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(this.width/3, this.height/3, 4, 0, Math.PI * 2);
                ctx.arc(this.width * 2/3, this.height/3, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.arc(this.width/3, this.height/3, 2, 0, Math.PI * 2);
                ctx.arc(this.width * 2/3, this.height/3, 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Mi·ªáng ma
                ctx.strokeStyle = '#000000';
                ctx.beginPath();
                ctx.arc(this.width/2, this.height * 2/3, 6, 0, Math.PI);
                ctx.stroke();
            }
            
            drawTurtleEnemy() {
                // Mai r√πa (m√†u n√¢u)
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.ellipse(this.width/2, this.height/2, this.width/2, this.height/2, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ƒê·∫ßu r√πa
                ctx.fillStyle = '#228B22';
                ctx.fillRect(this.width/2 - 8, -5, 16, 10);
                
                // M·∫Øt r√πa
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(this.width/2 - 6, -3, 3, 3);
                ctx.fillRect(this.width/2 + 3, -3, 3, 3);
                
                ctx.fillStyle = '#000000';
                ctx.fillRect(this.width/2 - 5, -2, 2, 2);
                ctx.fillRect(this.width/2 + 4, -2, 2, 2);
                
                // Ch√¢n r√πa
                ctx.fillStyle = '#228B22';
                ctx.fillRect(5, this.height - 5, 6, 8);
                ctx.fillRect(this.width - 11, this.height - 5, 6, 8);
            }
        }

        // L·ªõp n·ªÅn
        class Platform {
            constructor(x, y, width, height, color = '#8B4513') {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
            }
            
            draw() {
                ctx.save();
                
                // √Åp d·ª•ng scale v√† offset
                ctx.translate(offsetX, offsetY);
                ctx.scale(gameScale, gameScale);
                
                // √Åp d·ª•ng camera transform
                ctx.translate(-viewport.x, -viewport.y);
                
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // V·∫Ω texture g·∫°ch
                ctx.fillStyle = '#A0522D';
                for (let i = 0; i < this.width; i += 20) {
                    for (let j = 0; j < this.height; j += 10) {
                        ctx.fillRect(this.x + i, this.y + j, 18, 8);
                    }
                }
                
                ctx.restore();
            }
        }

        // L·ªõp ch∆∞·ªõng ng·∫°i v·∫≠t
        class Obstacle {
            constructor(x, y, width, height, color = '#FF0000') {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
            }
            
            draw() {
                ctx.save();
                
                // √Åp d·ª•ng scale v√† offset
                ctx.translate(offsetX, offsetY);
                ctx.scale(gameScale, gameScale);
                
                // √Åp d·ª•ng camera transform
                ctx.translate(-viewport.x, -viewport.y);
                
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // V·∫Ω gai
                ctx.fillStyle = '#000';
                for (let i = 0; i < this.width; i += 10) {
                    ctx.beginPath();
                    ctx.moveTo(this.x + i, this.y + this.height);
                    ctx.lineTo(this.x + i + 5, this.y);
                    ctx.lineTo(this.x + i + 10, this.y + this.height);
                    ctx.closePath();
                    ctx.fill();
                }
                
                ctx.restore();
            }
        }

        // L·ªõp ƒë·ªìng ti·ªÅn
        class Coin {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 20;
                this.height = 20;
                this.collected = false;
                this.animationFrame = 0;
            }
            
            update() {
                this.animationFrame = (this.animationFrame + 0.1) % 10;
            }
            
            draw() {
                if (this.collected) return;
                
                ctx.save();
                
                // √Åp d·ª•ng scale v√† offset
                ctx.translate(offsetX, offsetY);
                ctx.scale(gameScale, gameScale);
                
                // √Åp d·ª•ng camera transform
                ctx.translate(-viewport.x, -viewport.y);
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                
                // Hi·ªáu ·ª©ng xoay
                ctx.rotate(this.animationFrame * 0.2);
                
                // V·∫Ω ƒë·ªìng ti·ªÅn v√†ng
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(0, 0, this.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#FFA500';
                ctx.beginPath();
                ctx.arc(0, 0, this.width/3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
        }

        // L·ªõp ƒë√≠ch - THAY ƒê·ªîI: √î c·ª≠a c√¢u h·ªèi thay v√¨ c·ªù
        class Goal {
            constructor(x, y, width, height) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
            }
            
            draw() {
                ctx.save();
                
                // √Åp d·ª•ng scale v√† offset
                ctx.translate(offsetX, offsetY);
                ctx.scale(gameScale, gameScale);
                
                // √Åp d·ª•ng camera transform
                ctx.translate(-viewport.x, -viewport.y);
                
                // V·∫Ω khung c·ª≠a
                ctx.fillStyle = '#8B4513'; // M√†u n√¢u cho khung c·ª≠a
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // V·∫Ω c·ª≠a ch√≠nh
                ctx.fillStyle = '#A0522D'; // M√†u n√¢u ƒë·∫≠m h∆°n cho c·ª≠a
                ctx.fillRect(this.x + 5, this.y + 5, this.width - 10, this.height - 10);
                
                // V·∫Ω tay n·∫Øm c·ª≠a
                ctx.fillStyle = '#FFD700'; // M√†u v√†ng cho tay n·∫Øm
                ctx.beginPath();
                ctx.arc(this.x + this.width - 15, this.y + this.height / 2, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // V·∫Ω bi·ªÉn "√î c·ª≠a c√¢u h·ªèi"
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('√î C·ª¨A', this.x + this.width / 2, this.y - 25);
                ctx.fillText('C√ÇU H·ªéI', this.x + this.width / 2, this.y - 10);
                
                ctx.restore();
            }
        }

        // V·∫Ω c√¥ng ch√∫a
        function drawPrincess(x, y, width, height) {
            const princessCanvas = document.createElement('canvas');
            princessCanvas.width = width;
            princessCanvas.height = height;
            const pctx = princessCanvas.getContext('2d');
            
            // V∆∞∆°ng mi·ªán
            pctx.fillStyle = '#FFD700';
            pctx.beginPath();
            pctx.moveTo(width/2, 5);
            pctx.lineTo(width/2 - 10, 15);
            pctx.lineTo(width/2 + 10, 15);
            pctx.closePath();
            pctx.fill();
            
            // T√≥c
            pctx.fillStyle = '#FFD700';
            pctx.fillRect(width/2 - 15, 15, 30, 25);
            
            // M·∫∑t
            pctx.fillStyle = '#FFC0CB';
            pctx.fillRect(width/2 - 10, 20, 20, 15);
            
            // M·∫Øt
            pctx.fillStyle = '#000000';
            pctx.fillRect(width/2 - 7, 25, 3, 3);
            pctx.fillRect(width/2 + 4, 25, 3, 3);
            
            // ƒê·∫ßm m√†u h·ªìng
            pctx.fillStyle = '#FF69B4';
            pctx.fillRect(width/2 - 15, 40, 30, 45);
            
            // Tay
            pctx.fillStyle = '#FFC0CB';
            pctx.fillRect(width/2 - 20, 40, 5, 20);
            pctx.fillRect(width/2 + 15, 40, 5, 20);
            
            // V·∫Ω v√†o container
            princessContainer.innerHTML = '';
            princessContainer.appendChild(princessCanvas);
        }

        // C·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë
        function updateScore() {
            scoreIndicator.textContent = `ƒêi·ªÉm: ${score}`;
            headerScore.textContent = `ƒêi·ªÉm: ${score}`;
        }

        // C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi ch∆°i
        function updatePlayerName() {
            playerNameIndicator.textContent = `Ng∆∞·ªùi ch∆°i: ${playerName}`;
        }

        // C·∫≠p nh·∫≠t c·∫•p ƒë·ªô
        function updateLevel() {
            levelIndicator.textContent = `C·∫•p ƒë·ªô: ${currentLevel}/5`;
            headerLevel.textContent = `C·∫•p ƒë·ªô: ${currentLevel}/5`;
        }

        // T·∫°o ƒë·ªìng ti·ªÅn ng·∫´u nhi√™n
        function generateCoins() {
            coins = [];
            const numCoins = 8 + Math.floor(Math.random() * 7); // 8-14 ƒë·ªìng ti·ªÅn
            
            for (let i = 0; i < numCoins; i++) {
                let validPosition = false;
                let x, y;
                
                while (!validPosition) {
                    x = 100 + Math.random() * (GAME_WIDTH - 200);
                    y = 100 + Math.random() * (GAME_HEIGHT - 200);
                    
                    // Ki·ªÉm tra xem v·ªã tr√≠ c√≥ h·ª£p l·ªá kh√¥ng (kh√¥ng ch·ªìng l√™n ch∆∞·ªõng ng·∫°i v·∫≠t)
                    validPosition = true;
                    for (let obstacle of obstacles) {
                        if (x < obstacle.x + obstacle.width &&
                            x + 20 > obstacle.x &&
                            y < obstacle.y + obstacle.height &&
                            y + 20 > obstacle.y) {
                            validPosition = false;
                            break;
                        }
                    }
                    
                    // Ki·ªÉm tra xem c√≥ tr√™n n·ªÅn kh√¥ng
                    let onPlatform = false;
                    for (let platform of platforms) {
                        if (y + 20 >= platform.y && y <= platform.y + platform.height &&
                            x + 20 >= platform.x && x <= platform.x + platform.width) {
                            onPlatform = true;
                            // ƒê·∫∑t ƒë·ªìng ti·ªÅn tr√™n n·ªÅn
                            y = platform.y - 20;
                            break;
                        }
                    }
                    
                    if (!onPlatform) validPosition = false;
                }
                
                coins.push(new Coin(x, y));
            }
        }

        // T·∫°o qu√°i v·∫≠t v·ªõi s·ªë l∆∞·ª£ng tƒÉng d·∫ßn theo c·∫•p ƒë·ªô
        function generateEnemies() {
            enemies = [];
            
            // Ch·ªâ t·∫°o qu√°i v·∫≠t tr√™n c√°c n·ªÅn ph·ª• (tr·ª´ n·ªÅn ch√≠nh)
            const availablePlatforms = platforms.filter(p => p.y < GAME_HEIGHT - 30);
            
            // S·ªë l∆∞·ª£ng qu√°i v·∫≠t tƒÉng d·∫ßn theo c·∫•p ƒë·ªô
            let enemyCount;
            switch(currentLevel) {
                case 1:
                    enemyCount = 1; // M√†n 1: 1 qu√°i v·∫≠t
                    break;
                case 2:
                    enemyCount = 2; // M√†n 2: 2 qu√°i v·∫≠t
                    break;
                case 3:
                    enemyCount = 3; // M√†n 3: 3 qu√°i v·∫≠t
                    break;
                case 4:
                    enemyCount = 4; // M√†n 4: 4 qu√°i v·∫≠t
                    break;
                case 5:
                    enemyCount = 5; // M√†n 5: 5 qu√°i v·∫≠t
                    break;
                default:
                    enemyCount = 1;
            }
            
            // Ch·ªçn ng·∫´u nhi√™n c√°c n·ªÅn ƒë·ªÉ ƒë·∫∑t qu√°i v·∫≠t
            const selectedPlatforms = [];
            while (selectedPlatforms.length < enemyCount && selectedPlatforms.length < availablePlatforms.length) {
                const randomPlatform = availablePlatforms[Math.floor(Math.random() * availablePlatforms.length)];
                if (!selectedPlatforms.includes(randomPlatform)) {
                    selectedPlatforms.push(randomPlatform);
                }
            }
            
            // T·∫°o qu√°i v·∫≠t tr√™n c√°c n·ªÅn ƒë√£ ch·ªçn
            for (let platform of selectedPlatforms) {
                // T·∫°o v·ªã tr√≠ ng·∫´u nhi√™n tr√™n n·ªÅn
                const x = platform.x + 10 + Math.random() * (platform.width - 60);
                const y = platform.y - 40; // ƒê·∫∑t qu√°i v·∫≠t tr√™n n·ªÅn
                
                const speed = 1 + Math.random() * 1; // T·ªëc ƒë·ªô ng·∫´u nhi√™n
                
                // Ch·ªçn ng·∫´u nhi√™n lo·∫°i qu√°i v·∫≠t
                const enemyTypes = ['basic', 'spiky', 'fire', 'ghost', 'turtle'];
                const randomType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                
                enemies.push(new Enemy(x, y, 40, 40, speed, platform, randomType));
            }
        }

        // Kh·ªüi t·∫°o tr√≤ ch∆°i
        function initGame() {
            player = new Player();
            platforms = [];
            obstacles = [];
            enemies = [];
            coins = [];
            
            // T·∫°o n·ªÅn ch√≠nh
            platforms.push(new Platform(0, GAME_HEIGHT - 30, GAME_WIDTH, 30, '#8B4513'));
            
            // T·∫°o c√°c n·ªÅn v√† ch∆∞·ªõng ng·∫°i v·∫≠t d·ª±a tr√™n c·∫•p ƒë·ªô
            switch(currentLevel) {
                case 1:
                    platforms.push(new Platform(200, GAME_HEIGHT - 100, 150, 20, '#8B4513'));
                    platforms.push(new Platform(500, GAME_HEIGHT - 150, 150, 20, '#8B4513'));
                    platforms.push(new Platform(800, GAME_HEIGHT - 200, 150, 20, '#8B4513'));
                    obstacles.push(new Obstacle(350, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(650, GAME_HEIGHT - 60, 40, 30));
                    goal = new Goal(1000, GAME_HEIGHT - 220, 50, 70);
                    break;
                case 2:
                    platforms.push(new Platform(150, GAME_HEIGHT - 100, 120, 20, '#8B4513'));
                    platforms.push(new Platform(400, GAME_HEIGHT - 150, 120, 20, '#8B4513'));
                    platforms.push(new Platform(650, GAME_HEIGHT - 200, 120, 20, '#8B4513'));
                    platforms.push(new Platform(900, GAME_HEIGHT - 150, 120, 20, '#8B4513'));
                    obstacles.push(new Obstacle(280, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(530, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(780, GAME_HEIGHT - 60, 40, 30));
                    goal = new Goal(1050, GAME_HEIGHT - 170, 50, 70);
                    break;
                case 3:
                    platforms.push(new Platform(100, GAME_HEIGHT - 100, 100, 20, '#8B4513'));
                    platforms.push(new Platform(300, GAME_HEIGHT - 150, 100, 20, '#8B4513'));
                    platforms.push(new Platform(500, GAME_HEIGHT - 200, 100, 20, '#8B4513'));
                    platforms.push(new Platform(700, GAME_HEIGHT - 250, 100, 20, '#8B4513'));
                    platforms.push(new Platform(900, GAME_HEIGHT - 200, 100, 20, '#8B4513'));
                    obstacles.push(new Obstacle(200, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(400, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(600, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(800, GAME_HEIGHT - 60, 40, 30));
                    goal = new Goal(1050, GAME_HEIGHT - 220, 50, 70);
                    break;
                case 4:
                    platforms.push(new Platform(100, GAME_HEIGHT - 100, 90, 20, '#8B4513'));
                    platforms.push(new Platform(250, GAME_HEIGHT - 150, 90, 20, '#8B4513'));
                    platforms.push(new Platform(400, GAME_HEIGHT - 200, 90, 20, '#8B4513'));
                    platforms.push(new Platform(550, GAME_HEIGHT - 250, 90, 20, '#8B4513'));
                    platforms.push(new Platform(700, GAME_HEIGHT - 200, 90, 20, '#8B4513'));
                    platforms.push(new Platform(850, GAME_HEIGHT - 150, 90, 20, '#8B4513'));
                    obstacles.push(new Obstacle(175, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(325, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(475, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(625, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(775, GAME_HEIGHT - 60, 40, 30));
                    goal = new Goal(1000, GAME_HEIGHT - 170, 50, 70);
                    break;
                case 5:
                    platforms.push(new Platform(100, GAME_HEIGHT - 100, 80, 20, '#8B4513'));
                    platforms.push(new Platform(220, GAME_HEIGHT - 150, 80, 20, '#8B4513'));
                    platforms.push(new Platform(340, GAME_HEIGHT - 200, 80, 20, '#8B4513'));
                    platforms.push(new Platform(460, GAME_HEIGHT - 250, 80, 20, '#8B4513'));
                    platforms.push(new Platform(580, GAME_HEIGHT - 300, 80, 20, '#8B4513'));
                    platforms.push(new Platform(700, GAME_HEIGHT - 250, 80, 20, '#8B4513'));
                    platforms.push(new Platform(820, GAME_HEIGHT - 200, 80, 20, '#8B4513'));
                    platforms.push(new Platform(940, GAME_HEIGHT - 150, 80, 20, '#8B4513'));
                    obstacles.push(new Obstacle(160, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(280, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(400, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(520, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(640, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(760, GAME_HEIGHT - 60, 40, 30));
                    obstacles.push(new Obstacle(880, GAME_HEIGHT - 60, 40, 30));
                    goal = new Goal(1050, GAME_HEIGHT - 170, 50, 70);
                    break;
            }
            
            // T·∫°o ƒë·ªìng ti·ªÅn v√† qu√°i v·∫≠t
            generateCoins();
            generateEnemies();
            
            // Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng
            setupEnvironment();
            
            // C·∫≠p nh·∫≠t ch·ªâ s·ªë
            updateLevel();
            updateScore();
            updatePlayerName();
            
            // Reset camera
            viewport.x = 0;
            viewport.y = 0;
            
            // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n
            instructions.style.display = 'block';
            setTimeout(() => {
                instructions.style.display = 'none';
            }, 5000);
        }

        // V·∫Ω tr√≤ ch∆°i
        function draw() {
            // X√≥a canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // V·∫Ω m√¥i tr∆∞·ªùng
            drawEnvironment();
            
            // V·∫Ω c√°c ƒë·ªëi t∆∞·ª£ng game
            for (let platform of platforms) {
                platform.draw();
            }
            
            for (let obstacle of obstacles) {
                obstacle.draw();
            }
            
            for (let coin of coins) {
                coin.update();
                coin.draw();
            }
            
            for (let enemy of enemies) {
                enemy.update();
                enemy.draw();
            }
            
            goal.draw();
            player.draw();
        }

        // V√≤ng l·∫∑p tr√≤ ch∆°i
        function gameLoop() {
            try {
                if (!gameRunning) return;
                
                player.update();
                updateEnvironment();
                
                // Ph√°t √¢m thanh s·∫•m s√©t
                if (environment.lightningActive && environment.weather === 'rainy' && currentLevel === 5) {
                    playThunderSound();
                }
                
                draw();
                
                requestAnimationFrame(gameLoop);
            } catch (error) {
                handleGameError(error);
            }
        }

        // Hi·ªÉn th·ªã c√¢u h·ªèi
        function showQuestion() {
            gameRunning = false;
            questionScreen.style.display = 'flex';
            questionNumber.textContent = `C√¢u h·ªèi ${currentLevel}`;
            questionText.textContent = questions[currentQuestion].text;
            
            // X√≥a c√°c ƒë√°p √°n c≈©
            answersContainer.innerHTML = '';
            selectedAnswer = null;
            
            // Th√™m c√°c ƒë√°p √°n m·ªõi
            questions[currentQuestion].options.forEach((option, index) => {
                const answerElement = document.createElement('div');
                answerElement.className = 'answer-option';
                answerElement.textContent = option;
                answerElement.dataset.index = index;
                answerElement.addEventListener('click', () => {
                    // B·ªè ch·ªçn t·∫•t c·∫£
                    document.querySelectorAll('.answer-option').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    // Ch·ªçn ƒë√°p √°n n√†y
                    answerElement.classList.add('selected');
                    selectedAnswer = index;
                });
                
                answersContainer.appendChild(answerElement);
            });
        }

        // Ki·ªÉm tra ƒë√°p √°n
        function checkAnswer() {
            if (selectedAnswer === null) {
                alert('Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n!');
                return;
            }
            
            const isCorrect = selectedAnswer === questions[currentQuestion].correct;
            
            if (isCorrect) {
                resultText.textContent = 'ƒê√°p √°n ƒë√∫ng!';
                resultMessage.textContent = 'B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng. Ti·∫øp t·ª•c cu·ªôc phi√™u l∆∞u!';
                score += 50; // Th√™m ƒëi·ªÉm khi tr·∫£ l·ªùi ƒë√∫ng
                updateScore();
                playCorrectSound();
                
                // Chuy·ªÉn sang c·∫•p ƒë·ªô ti·∫øp theo
                currentLevel++;
                currentQuestion++;
                
                if (currentLevel > 5) {
                    // Ho√†n th√†nh tr√≤ ch∆°i
                    resultBtn.textContent = 'K·∫øt th√∫c';
                } else {
                    resultBtn.textContent = 'Ti·∫øp t·ª•c';
                }
            } else {
                resultText.textContent = 'ƒê√°p √°n sai!';
                resultMessage.textContent = 'B·∫°n ƒë√£ tr·∫£ l·ªùi sai. Quay l·∫°i ƒëi·ªÉm xu·∫•t ph√°t!';
                playWrongSound();
                player.reset();
                resultBtn.textContent = 'Th·ª≠ l·∫°i';
            }
            
            resultScreen.style.display = 'flex';
            questionScreen.style.display = 'none';
        }

        // Th√™m h√†m x·ª≠ l√Ω l·ªói chung
        function handleGameError(error) {
            console.error('Game error:', error);
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói th√¢n thi·ªán
            if (!document.getElementById('error-message')) {
                const errorDiv = document.createElement('div');
                errorDiv.id = 'error-message';
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    z-index: 1000;
                    text-align: center;
                `;
                errorDiv.innerHTML = `
                    <h3>ƒê√£ x·∫£y ra l·ªói</h3>
                    <p>Vui l√≤ng th·ª≠ l√†m m·ªõi trang</p>
                    <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px;">L√†m m·ªõi</button>
                `;
                document.body.appendChild(errorDiv);
            }
        }

        // X·ª≠ l√Ω s·ª± ki·ªán
        loginBtn.addEventListener('click', () => {
            const name = playerNameInput.value.trim();
            if (name) {
                playerName = name;
                welcomeName.textContent = playerName;
                congratsName.textContent = playerName;
                loginScreen.style.display = 'none';
                startScreen.style.display = 'flex';
            } else {
                alert('Vui l√≤ng nh·∫≠p t√™n nh√¢n v·∫≠t!');
            }
        });

        playerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });

        startBtn.addEventListener('click', () => {
            startScreen.style.display = 'none';
            gameRunning = true;
            initGame();
            playBackgroundMusic();
            gameLoop();
        });

        restartBtn.addEventListener('click', () => {
            endScreen.style.display = 'none';
            currentLevel = 1;
            currentQuestion = 0;
            score = 0;
            gameRunning = true;
            initGame();
            gameLoop();
        });

        submitBtn.addEventListener('click', checkAnswer);

        resultBtn.addEventListener('click', () => {
            resultScreen.style.display = 'none';
            
            if (currentLevel > 5) {
                // K·∫øt th√∫c tr√≤ ch∆°i - v·∫Ω c√¥ng ch√∫a
                drawPrincess(0, 0, 80, 100);
                finalScore.textContent = `T·ªïng ƒëi·ªÉm: ${score}`;
                endScreen.style.display = 'flex';
                playWinSound();
            } else {
                // Ti·∫øp t·ª•c tr√≤ ch∆°i
                gameRunning = true;
                initGame();
                gameLoop();
            }
        });

        // B·∫≠t/t·∫Øt √¢m thanh
        audioToggle.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            audioToggle.textContent = soundEnabled ? 'üîä' : 'üîá';
        });

        // Fullscreen toggle
        fullscreenToggle.addEventListener('click', toggleFullscreen);

        // X·ª≠ l√Ω s·ª± ki·ªán b√†n ph√≠m
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // X·ª≠ l√Ω ƒëi·ªÅu khi·ªÉn c·∫£m ·ª©ng
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchControls.left = true;
        });

        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            touchControls.left = false;
        });

        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchControls.right = true;
        });

        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            touchControls.right = false;
        });

        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchControls.jump = true;
        });

        jumpBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            touchControls.jump = false;
        });

        // NgƒÉn ch·∫∑n cu·ªôn trang tr√™n thi·∫øt b·ªã c·∫£m ·ª©ng
        document.addEventListener('touchmove', (e) => {
            if (e.target === canvas || 
                e.target === leftBtn || 
                e.target === rightBtn || 
                e.target === jumpBtn) {
                e.preventDefault();
            }
        }, { passive: false });

        // X·ª≠ l√Ω thay ƒë·ªïi k√≠ch th∆∞·ªõc m√†n h√¨nh
        window.addEventListener('resize', () => {
            initCanvasSize();
            checkOrientation();
        });

        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                initCanvasSize();
                checkOrientation();
            }, 100);
        });

        // X·ª≠ l√Ω fullscreen change
        document.addEventListener('fullscreenchange', () => {
            isFullscreen = !!document.fullscreenElement;
            fullscreenToggle.textContent = isFullscreen ? '‚õ∂' : '‚õ∂';
        });

        // ƒê·∫£m b·∫£o n√∫t b·∫Øt ƒë·∫ßu c√≥ th·ªÉ nh·∫•n ƒë∆∞·ª£c tr√™n mobile
        startBtn.style.touchAction = 'manipulation';
        startBtn.style.cursor = 'pointer';

        // Th√™m s·ª± ki·ªán cho n√∫t ƒëƒÉng nh·∫≠p
        loginBtn.style.touchAction = 'manipulation';
        loginBtn.style.cursor = 'pointer';

        // ƒê·∫£m b·∫£o input c√≥ th·ªÉ nh·∫≠p ƒë∆∞·ª£c tr√™n mobile
        playerNameInput.style.touchAction = 'manipulation';

        // Kh·ªüi t·∫°o ban ƒë·∫ßu
        initCanvasSize();
        checkOrientation();
    </script>
</body>
</html>
